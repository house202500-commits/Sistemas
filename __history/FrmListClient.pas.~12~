unit FrmListClient;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Buttons, Vcl.ExtCtrls,
  Vcl.Imaging.pngimage,FrClientVend,conexao,FrmCadastro, System.UITypes,FireDAC.Comp.Client,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf,
  FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt, FireDAC.Stan.Param,FrmConsult;


type
  TFrmLista = class(TForm)
    Panel2: TPanel;
    Panel1: TPanel;
    LbClient: TLabel;
    Label01: TLabel;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Panel3: TPanel;
    btnEdtClien: TSpeedButton;
    Panel4: TPanel;
    btnNovoClien: TSpeedButton;
    Panel5: TPanel;
    btnSelect: TSpeedButton;
    Panel6: TPanel;
    btnFecClient: TSpeedButton;
    LblCPF: TLabel;
    LbEnderco: TLabel;
    LbCidade: TLabel;
    LbTelefone: TLabel;
    LbEmail: TLabel;
    LbCadastro: TLabel;
    LbStatus: TLabel;
    LbUF: TLabel;
    LbBairro: TLabel;
    LbCEP: TLabel;
    btnEditar: TButton;
    edtEndereco: TEdit;
    edtEmail: TEdit;
    edtTelefone: TEdit;
    edtCidade: TEdit;
    edtCEP: TEdit;
    BtnSalvar: TButton;
    btnConfirm: TSpeedButton;
    EdtUF: TEdit;
    edtNum: TEdit;
    edtBairro: TEdit;
    Label6: TLabel;
    Button1: TButton;
    Button2: TButton;
    LbNum: TLabel;
    procedure btnFecClientMouseEnter(Sender: TObject);
    procedure btnFecClientMouseLeave(Sender: TObject);
    procedure btnNovoClienMouseEnter(Sender: TObject);
    procedure btnNovoClienMouseLeave(Sender: TObject);
    procedure btnEdtClienMouseEnter(Sender: TObject);
    procedure btnSelectMouseEnter(Sender: TObject);
    procedure btnSelectMouseLeave(Sender: TObject);
    procedure btnEdtClienMouseLeave(Sender: TObject);
    procedure FormCreate(Sender: TObject);

    procedure CarregarGlyphPNG;
    procedure btnSelectClick(Sender: TObject);
    procedure btnEdtClienClick(Sender: TObject);
    procedure btnFecClientClick(Sender: TObject);
    procedure btnNovoClienClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnEditarClick(Sender: TObject);
    procedure BtnSalvarClick(Sender: TObject);


    procedure btnConfirmClick(Sender: TObject);

    procedure AtualizarEndereco;


    procedure btnConfirmMouseEnter(Sender: TObject);
    procedure btnConfirmMouseLeave(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);  private
    { Private declarations }
    FModoEdicao: Boolean;
    FIDClienteAtual: Integer;
    GlyphOriginal: TBitmap;
  //  procedure HabilitarControles(Ativo: Boolean);

   // snapshot dos dados originais
  FEnderecoOld, FCidadeOld, FCEPOld, FTelefoneOld, FEmailOld: string;
  public
    { Public declarations }
  end;

var
  FrmLista: TFrmLista;

implementation
 uses
 FrmVendas;
{$R *.dfm}

procedure TFrmLista.AtualizarEndereco;
begin
     // Junta os textos das labels individuais no Label1
  LbEnderco.Caption := LbEnderco.Caption + ', ' +
                       LbNum.Caption   + ' - ' +
                       LbBairro.Caption  ;


  LbCidade.Caption :=  LbCidade.Caption + ' / ' +
                       LbUF.Caption + ' - ' +
                       LbCEP.Caption ;
end;


procedure TFrmLista.btnEdtClienClick(Sender: TObject);
begin
  FIDClienteAtual := Dm.QryCadClientes.FieldByName('ID_CLIENTE').AsInteger;

  if FIDClienteAtual <= 0 then
  begin
    ShowMessage('Selecione um cliente válido para editar!');
    Exit;
  end;

  // guarda valores originais
  FEnderecoOld := edtEndereco.Text;
  FCidadeOld   := edtCidade.Text;
  FCEPOld      := edtCEP.Text;
  FTelefoneOld := edtTelefone.Text;
  FEmailOld    := edtEmail.Text;

  // entra em modo edição
  FModoEdicao := True;

  // alterna visual
  LbEnderco.Visible   := False;
  LbCidade.Visible   := False;
  LbCEP.Visible   := False;
  LbTelefone.Visible   := False;
  LbEmail.Visible   := False;

  edtEndereco.Visible := True;
  edtCidade.Visible := True;;
  edtCEP.Visible := True;
  edtTelefone.Visible := True;
  edtEmail.Visible := True;



  edtEndereco.ReadOnly := False;
  edtCidade.ReadOnly   := False;
  edtCEP.ReadOnly      := False;
  edtTelefone.ReadOnly := False;
  edtEmail.ReadOnly    := False;

  edtEndereco.SetFocus;

  btnConfirm.Visible := true;
  btnEdtClien.Visible := false;
end;


procedure TFrmLista.btnEdtClienMouseEnter(Sender: TObject);
begin
  btnEdtClien.Font.Color := $00908E4C;
  btnEdtClien.Glyph.Assign(nil);
end;

procedure TFrmLista.btnEdtClienMouseLeave(Sender: TObject);
begin
   btnEdtClien.Font.Color := clWhite;
   CarregarGlyphPNG;
end;

procedure TFrmLista.btnFecClientClick(Sender: TObject);

{
begin
  if FModoEdicao then
  begin
    if MessageDlg('Cancelar edição? As alterações serão perdidas.',
                  mtConfirmation, [mbYes, mbNo], 0) = mrYes then
    begin
      FModoEdicao := False;
      FIDClienteAtual := 0;
    end;
  end
  else

  }

  begin
    Close;
  end;


procedure TFrmLista.btnFecClientMouseEnter(Sender: TObject);
begin
   btnFecClient.Font.Color := $00908E4C;
   btnFecClient.Glyph.Assign(nil);
end;

procedure TFrmLista.btnFecClientMouseLeave(Sender: TObject);
begin
   btnFecClient.Font.Color := clWhite;
   CarregarGlyphPNG;
end;

procedure TFrmLista.btnNovoClienClick(Sender: TObject);
begin
  FModoEdicao := False;
  FIDClienteAtual := 0;
  FrmClientes.visible := not FrmClientes.visible;
end;

procedure TFrmLista.btnNovoClienMouseEnter(Sender: TObject);
begin
  btnNovoClien.Font.Color := $00908E4C;
  btnNovoClien.Glyph.Assign(nil);
end;

procedure TFrmLista.btnNovoClienMouseLeave(Sender: TObject);
begin
   btnNovoClien.Font.Color := clWhite;
   CarregarGlyphPNG;
end;

procedure TFrmLista.btnSelectClick(Sender: TObject);
begin

  FrmVenda.show;

  FrmVenda.Edit3.Text := LbClient.Caption ;
  FrmVenda.LisBox.Items.Add(
    'Endereço: ' + LbEnderco.Caption + ', ' +
    LbNum.Caption + ' , ' +
    LbBairro.Caption
  );

  FrmVenda.LisBox.Items.Add(
    LbCidade.Caption + ' / ' + LbUF.Caption + '     ' + LbCEP.Caption
  );

  LbUF.AutoSize := True;
  LbCEP.AutoSize := True;

  LbCEP.Left := LbUF.Left + LbUF.Width + 25;
end;


procedure TFrmLista.btnSelectMouseEnter(Sender: TObject);
begin
  btnSelect.Font.Color := $00908E4C;
  btnSelect.Glyph.Assign(nil);
end;

procedure TFrmLista.btnSelectMouseLeave(Sender: TObject);
begin
  btnSelect.Font.Color := clWhite;
  CarregarGlyphPNG;
end;


procedure TFrmLista.Button1Click(Sender: TObject);

var
  Endereco, Bairro, EnderecoCompleto: string;
begin
  // Simulando dados
  Endereco := 'Rua dos Bobos, 00 - Centro';
  Bairro := 'Jardim das Flores';

  // Concatenar com validação
  if (Trim(Endereco) <> '') and (Trim(Bairro) <> '') then
    EnderecoCompleto := Trim(Endereco) + ', ' + Trim(Bairro)
  else
    EnderecoCompleto := Trim(Endereco) + Trim(Bairro);

  // Atribuir ao Label
  Label6.Caption := EnderecoCompleto;

  // Opcional: Se a altura precisar ajustar dinamicamente
  // após o WordWrap, você pode precisar calcular a altura da fonte:
  // Label1.Height := Label1.Canvas.TextHeight(Label1.Caption) * 2;
end;


procedure TFrmLista.Button2Click(Sender: TObject);
begin
  AtualizarEndereco;
end;

procedure TFrmLista.BtnSalvarClick(Sender: TObject);
var
  Qry: TFDQuery;
begin
  if not FModoEdicao then
    Exit;

  // 🔹 se não mudou nada → volta tudo e sai
  if (edtEndereco.Text = FEnderecoOld) and
     (edtCidade.Text   = FCidadeOld) and
     (edtCEP.Text      = FCEPOld) and
     (edtTelefone.Text = FTelefoneOld) and
     (edtEmail.Text    = FEmailOld) then
  begin
    edtEndereco.Text := FEnderecoOld;
    edtCidade.Text   := FCidadeOld;
    edtCEP.Text      := FCEPOld;
    edtTelefone.Text := FTelefoneOld;
    edtEmail.Text    := FEmailOld;

    FModoEdicao := False;
    Exit;
  end;

  // 🔹 valida campos
  if (Trim(edtEndereco.Text) = '') or
     (Trim(edtCidade.Text)   = '') or
     (Trim(edtCEP.Text)      = '') or
     (Trim(edtTelefone.Text) = '') or
     (Trim(edtEmail.Text)    = '') then
  begin
    ShowMessage('Atenção: Todos os campos devem ser preenchidos!');
    Exit;
  end;

  // 🔹 salva no banco
  Qry := TFDQuery.Create(nil);
  try
    Qry.Connection := Dm.Fconexao;

    Qry.SQL.Text :=
      'UPDATE CLIENTES SET ' +
      ' EMAIL = :EMAIL, ' +
      ' TELEFONE = :TELEFONE, ' +
      ' CEP = :CEP, ' +
      ' ENDERECO = :ENDERECO, ' +
      ' CIDADE = :CIDADE ' +
      'WHERE ID_CLIENTE = :ID';

    Qry.ParamByName('EMAIL').AsString    := edtEmail.Text;
    Qry.ParamByName('TELEFONE').AsString := edtTelefone.Text;
    Qry.ParamByName('CEP').AsString      := edtCEP.Text;
    Qry.ParamByName('ENDERECO').AsString := edtEndereco.Text;
    Qry.ParamByName('CIDADE').AsString   := edtCidade.Text;
    Qry.ParamByName('ID').AsInteger      := FIDClienteAtual;

    Qry.ExecSQL;

    // atualiza visual
    LbEnderco.Caption := edtEndereco.Text;
    LbCidade.Caption := edtCidade.Text;
    LbEmail.Caption := edtEmail.Text;
    LbCEP.Caption := edtCEP.Text;
    LbTelefone.Caption := edtTelefone.Text;

    Dm.QryCadClientes.Refresh;

    ShowMessage('Cadastro atualizado com sucesso!');
  finally
    Qry.Free;
  end;

  // sai do modo edição
    edtEndereco.Visible := False;
    edtCidade.Visible := False;
    edtCEP.Visible := False;
    edtTelefone.Visible := False;
    edtEmail.Visible := False;


    LbEnderco.Visible := True;
    LbCidade.Visible  := True;
    LbCEP.Visible := True;
    LbTelefone.Visible := True;
    LbEmail.Visible := True;

end;


procedure TFrmLista.btnConfirmClick(Sender: TObject);
var
  Qry: TFDQuery;
begin

  btnConfirm.Visible := False;

  if not FModoEdicao then
    Exit;

  // 🔹 se não mudou nada → volta tudo e sai
  if (edtEndereco.Text = FEnderecoOld) and
     (edtCidade.Text   = FCidadeOld) and
     (edtCEP.Text      = FCEPOld) and
     (edtTelefone.Text = FTelefoneOld) and
     (edtEmail.Text    = FEmailOld) then
  begin
    edtEndereco.Text := FEnderecoOld;
    edtCidade.Text   := FCidadeOld;
    edtCEP.Text      := FCEPOld;
    edtTelefone.Text := FTelefoneOld;
    edtEmail.Text    := FEmailOld;

    FModoEdicao := False;
    Exit;
  end;

  // 🔹 valida campos
  if (Trim(edtEndereco.Text) = '') or
     (Trim(edtCidade.Text)   = '') or
     (Trim(edtCEP.Text)      = '') or
     (Trim(edtTelefone.Text) = '') or
     (Trim(edtEmail.Text)    = '') then
  begin
    ShowMessage('Atenção: Todos os campos devem ser preenchidos!');
    Exit;
  end;

  // 🔹 salva no banco
  Qry := TFDQuery.Create(nil);
  try
    Qry.Connection := Dm.Fconexao;

    Qry.SQL.Text :=
      'UPDATE CLIENTES SET ' +
      ' EMAIL = :EMAIL, ' +
      ' TELEFONE = :TELEFONE, ' +
      ' CEP = :CEP, ' +
      ' ENDERECO = :ENDERECO, ' +
      ' CIDADE = :CIDADE ' +
      'WHERE ID_CLIENTE = :ID';

    Qry.ParamByName('EMAIL').AsString    := edtEmail.Text;
    Qry.ParamByName('TELEFONE').AsString := edtTelefone.Text;
    Qry.ParamByName('CEP').AsString      := edtCEP.Text;
    Qry.ParamByName('ENDERECO').AsString := edtEndereco.Text;
    Qry.ParamByName('CIDADE').AsString   := edtCidade.Text;
    Qry.ParamByName('ID').AsInteger      := FIDClienteAtual;

    Qry.ExecSQL;

    // atualiza visual
    LbEnderco.Caption := edtEndereco.Text;
    LbCidade.Caption := edtCidade.Text;
    LbEmail.Caption := edtEmail.Text;
    LbCEP.Caption := edtCEP.Text;
    LbTelefone.Caption := edtTelefone.Text;

    Dm.QryCadClientes.Refresh;

    ShowMessage('Cadastro atualizado com sucesso!');
  finally
    Qry.Free;
  end;

  // sai do modo edição
    edtEndereco.Visible := False;
    edtCidade.Visible := False;
    edtCEP.Visible := False;
    edtTelefone.Visible := False;
    edtEmail.Visible := False;


    LbEnderco.Visible := True;
    LbCidade.Visible  := True;
    LbCEP.Visible := True;
    LbTelefone.Visible := True;
    LbEmail.Visible := True;


  btnEdtClien.Visible := True;
end;

procedure TFrmLista.btnConfirmMouseEnter(Sender: TObject);
begin
  btnConfirm.Font.Color := $00908E4C;
  btnConfirm.Glyph.Assign(nil);
end;

procedure TFrmLista.btnConfirmMouseLeave(Sender: TObject);
begin
   btnConfirm.Font.Color := clWhite;
   CarregarGlyphPNG;
end;

procedure TFrmLista.btnEditarClick(Sender: TObject);
begin
  FIDClienteAtual := Dm.QryCadClientes.FieldByName('ID_CLIENTE').AsInteger;

  if FIDClienteAtual <= 0 then
  begin
    ShowMessage('Selecione um cliente válido para editar!');
    Exit;
  end;

  // guarda valores originais
  FEnderecoOld := edtEndereco.Text;
  FCidadeOld   := edtCidade.Text;
  FCEPOld      := edtCEP.Text;
  FTelefoneOld := edtTelefone.Text;
  FEmailOld    := edtEmail.Text;

  // entra em modo edição
  FModoEdicao := True;

  // alterna visual
  LbEnderco.Visible   := False;
  LbCidade.Visible   := False;
  LbCEP.Visible   := False;
  LbTelefone.Visible   := False;
  LbEmail.Visible   := False;

  edtEndereco.Visible := True;
  edtCidade.Visible := True;;
  edtCEP.Visible := True;
  edtTelefone.Visible := True;
  edtEmail.Visible := True;



  edtEndereco.ReadOnly := False;
  edtCidade.ReadOnly   := False;
  edtCEP.ReadOnly      := False;
  edtTelefone.ReadOnly := False;
  edtEmail.ReadOnly    := False;

  edtEndereco.SetFocus;
end;


procedure TFrmLista.CarregarGlyphPNG;
var
  Png: TPngImage;
begin
  Png := TPngImage.Create;
  try
    Png.LoadFromFile('C:\Users\User\Downloads\img\verificado.png');
    btnSelect.Glyph.Assign(Png);

    Png.LoadFromFile('C:\Users\User\Downloads\img\editar.png');
    btnEdtClien.Glyph.Assign(Png);

    Png.LoadFromFile('C:\Users\User\Downloads\img\editar.png');
    btnConfirm.Glyph.Assign(Png);

    Png.LoadFromFile('C:\Users\User\Downloads\img\novo-usuario.png');
    btnNovoClien.Glyph.Assign(Png);

    Png.LoadFromFile('C:\Users\User\Downloads\img\fechar.png');
    btnFecClient.Glyph.Assign(Png);

  finally
    Png.Free;
  end;
end;


procedure TFrmLista.FormCreate(Sender: TObject);
begin
  GlyphOriginal := TBitmap.Create;
  GlyphOriginal.Assign(btnEdtClien.Glyph);
  GlyphOriginal.Assign(btnSelect.Glyph);
  GlyphOriginal.Assign(btnNovoClien.Glyph);
  GlyphOriginal.Assign(btnFecClient.Glyph);

end;

procedure TFrmLista.FormShow(Sender: TObject);
var
  Status: string;
begin
  Status := Trim(Dm.QryCadClientes.FieldByName('STATUS').AsString);

  if Status = 'A' then
    LbStatus.Caption := 'Ativo'
  else if Status = 'I' then
    LbStatus.Caption := 'Inativo'
  else
    LbStatus.Caption := 'Desconhecido';
end;


end.procedure TFrmLista.LbTelefoneClick(Sender: TObject);
begin

end;


