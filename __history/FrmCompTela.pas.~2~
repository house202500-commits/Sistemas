unit FrmCompTela;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls,
      conexao,
  FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Error, FireDAC.UI.Intf, FireDAC.Phys.Intf,
  FireDAC.Stan.Def, FireDAC.Stan.Pool, FireDAC.Stan.Async,
  FireDAC.Phys, FireDAC.Phys.FB, // Para FireBird
  FireDAC.VCLUI.Wait, FireDAC.Stan.Param, FireDAC.DatS,
  FireDAC.DApt.Intf, FireDAC.DApt, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client,FrmConsult, Vcl.DBCtrls, Data.DB;

type
  TFrmTelaCompras = class(TForm)
    Panel2: TPanel;
    Label20: TLabel;
    LbDesProdC: TLabel;
    LbQuantidC: TLabel;
    Label5: TLabel;
    LbVUnitC: TLabel;
    Label6: TLabel;
    LbDescontC: TLabel;
    Label8: TLabel;
    LbVlorItemC: TLabel;
    Label9: TLabel;
    LbCliente: TLabel;
    Label2: TLabel;
    LbTotalComp: TLabel;
    Label3: TLabel;
    LbDataComp: TLabel;
    LbNumCompr: TLabel;
    Label13: TLabel;
    Label1: TLabel;
    CbQuatEditar: TComboBox;
    Button1: TButton;
    mtItens: TFDMemTable;
    dsItens: TDataSource;
    Edit1: TEdit;
    Edit2: TEdit;
    procedure CbQuatEditarChange(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FrmTelaCompras: TFrmTelaCompras;

implementation
 uses
 FrmVendas;
{$R *.dfm}

procedure TFrmTelaCompras.Button1Click(Sender: TObject);
var
  Quant: Integer;
  ValUnit, Desc, TotItem, SomaTotal: Double;
  Descricao: string;
begin
  // Garantir que o dataset esteja aberto
  if not mtItens.Active then
    mtItens.Open;

  // Ler valores dos controles
  Quant := StrToIntDef(CbQuatEditar.Text, 1);
 // Descricao := LbDesProdC.Text;
  ValUnit := StrToFloatDef(LbVUnitC.Caption, 0);
  Desc := StrToFloatDef(StringReplace(LbDescontC.Caption, '%', '', [rfReplaceAll]), 0) / 100;

  // Calcular total do item
  TotItem := Quant * ValUnit * (1 - Desc);

  // Inserir registro no dataset
  mtItens.Append;
  mtItens.FieldByName('CODIGO').AsInteger := StrToIntDef(LbNumCompr.Caption, 0);
  mtItens.FieldByName('DESCRICAO').AsString := Descricao;
  mtItens.FieldByName('QUANTIDADE').AsInteger := Quant;
  mtItens.FieldByName('VALOR_UNIT').AsFloat := ValUnit;
  mtItens.FieldByName('DESCONTO').AsFloat := Desc * 100; // armazenado como percentual
  mtItens.FieldByName('TOTAL_ITEM').AsFloat := TotItem;
  mtItens.Post;

  // Somar TOTAL_ITEM
  SomaTotal := 0;
  mtItens.First;
  while not mtItens.Eof do
  begin
    SomaTotal := SomaTotal + mtItens.FieldByName('TOTAL_ITEM').AsFloat;
    mtItens.Next;
  end;

  FrmVenda.LbValorTl.Caption := FormatFloat('0.00', SomaTotal);

  dsItens.DataSet := mtItens;
  FrmVenda.DBGrid1.DataSource := dsItens;
end;

procedure TFrmTelaCompras.CbQuatEditarChange(Sender: TObject);
var
  Quantidade: Integer;
  ValorUnit: Double;
  Total: Double;
begin
  // Quantidade
  if not TryStrToInt(CbQuatEditar.Text, Quantidade) then
    Quantidade := 0;

  // Valor unitário (Label)
  if not TryStrToFloat(LbVUnitC.Caption, ValorUnit) then
    ValorUnit := 0;

  Total := Quantidade * ValorUnit;

  // Mostrar total no Label
  LbTotalComp.Caption := FormatFloat('0.00', Total);
end;

procedure TFrmTelaCompras.FormCreate(Sender: TObject);
begin
  // Definir os campos do dataset em tempo de execução
  mtItens.FieldDefs.Clear;
  mtItens.FieldDefs.Add('CODIGO', ftInteger);
  mtItens.FieldDefs.Add('DESCRICAO', ftString, 100);
  mtItens.FieldDefs.Add('QUANTIDADE', ftInteger);
  mtItens.FieldDefs.Add('VALOR_UNIT', ftFloat);
  mtItens.FieldDefs.Add('DESCONTO', ftFloat);
  mtItens.FieldDefs.Add('TOTAL_ITEM', ftFloat);

  // Criar o dataset
  mtItens.CreateDataSet;

end;


end.
